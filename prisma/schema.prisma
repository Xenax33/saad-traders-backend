// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                          String     @id @default(uuid())
  name                        String
  email                       String     @unique
  businessName                String     @map("business_name")
  province                    String
  address                     String
  ntncnic                     String     @unique @map("ntn_cnic")
  role                        Role       @default(USER)
  password                    String
  mfaEnabled                  Boolean    @default(false) @map("mfa_enabled")
  mfaSecret                   String?    @map("mfa_secret")
  mfaBackupCodes              String[]   @default([]) @map("mfa_backup_codes")
  postInvoiceTokenTest        String?    @map("post_invoice_token_test")
  validateInvoiceTokenTest    String?    @map("validate_invoice_token_test")
  postInvoiceToken            String?    @map("post_invoice_token")
  validateInvoiceToken        String?    @map("validate_invoice_token")
  isActive                    Boolean    @default(true) @map("is_active")
  createdAt                   DateTime   @default(now()) @map("created_at")
  updatedAt                   DateTime   @updatedAt @map("updated_at")
  
  // Relations
  userScenarios               UserScenario[]
  products                    Product[]
  refreshTokens               RefreshToken[]
  invoices                    Invoice[]
  buyers                      Buyer[]
  hsCodes                     HsCode[]
  customFields                CustomField[]
  invoicePrintSettings        InvoicePrintSettings?

  @@map("users")
}

model RefreshToken {
  id        String   @id @default(uuid())
  token     String   @unique
  userId    String   @map("user_id")
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")
  
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("refresh_tokens")
}

model HsCode {
  id           String        @id @default(uuid())
  userId       String        @map("user_id")
  hsCode       String        @map("hs_code")
  description  String?
  createdAt    DateTime      @default(now()) @map("created_at")
  updatedAt    DateTime      @updatedAt @map("updated_at")
  
  // Relations
  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  invoiceItems InvoiceItem[]

  @@unique([userId, hsCode])
  @@map("hs_codes")
}

model GlobalScenario {
  id                  String          @id @default(uuid())
  scenarioCode        String          @unique @map("scenario_code")
  scenarioDescription String          @map("scenario_description")
  salesType           String?         @map("sales_type")
  fbrId               Int             @map("fbr_id")
  createdAt           DateTime        @default(now()) @map("created_at")
  updatedAt           DateTime        @updatedAt @map("updated_at")
  
  // Relations
  userScenarios       UserScenario[]
  invoices            Invoice[]

  @@map("global_scenarios")
}

model UserScenario {
  id         String         @id @default(uuid())
  userId     String         @map("user_id")
  scenarioId String         @map("scenario_id")
  createdAt  DateTime       @default(now()) @map("created_at")
  
  // Relations
  user       User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  scenario   GlobalScenario @relation(fields: [scenarioId], references: [id], onDelete: Cascade)

  @@unique([userId, scenarioId])
  @@map("user_scenarios")
}


model Buyer {
  id                    String    @id @default(uuid())
  userId                String    @map("user_id")
  ntncnic               String    @map("ntn_cnic")
  businessName          String    @map("business_name")
  province              String
  address               String
  registrationType      String    @map("registration_type")
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")
  
  // Relations
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  invoices              Invoice[]

  @@unique([userId, ntncnic])
  @@map("buyers")
}

model Product {
  id                        String   @id @default(uuid())
  userId                    String   @map("user_id")
  productDescription        String   @map("product_description")
  value                     Decimal  @db.Decimal(15, 2)
  valueExcludingSalesTax    Decimal  @map("value_excluding_sales_tax") @db.Decimal(15, 2)
  retailPrice               Decimal  @map("retail_price") @db.Decimal(15, 2)
  createdAt                 DateTime @default(now()) @map("created_at")
  updatedAt                 DateTime @updatedAt @map("updated_at")
  
  user                      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("products")
}

model Invoice {
  id                      String        @id @default(uuid())
  userId                  String        @map("user_id")
  buyerId                 String        @map("buyer_id")
  scenarioId              String?       @map("scenario_id")
  invoiceType             String        @map("invoice_type")
  invoiceDate             DateTime      @map("invoice_date") @db.Date
  invoiceRefNo            String?       @map("invoice_ref_no")
  fbrInvoiceNumber        String?       @map("fbr_invoice_number")
  fbrResponse             Json?         @map("fbr_response")
  isTestEnvironment       Boolean       @default(true) @map("is_test_environment")
  createdAt               DateTime      @default(now()) @map("created_at")
  updatedAt               DateTime      @updatedAt @map("updated_at")
  
  // Relations
  user                    User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  buyer                   Buyer          @relation(fields: [buyerId], references: [id], onDelete: Restrict)
  scenario                GlobalScenario? @relation(fields: [scenarioId], references: [id], onDelete: Restrict)
  items                   InvoiceItem[]

  @@map("invoices")
}

model InvoiceItem {
  id                            String          @id @default(uuid())
  invoiceId                     String          @map("invoice_id")
  hsCodeId                      String          @map("hs_code_id")
  productDescription            String          @map("product_description")
  rate                          String
  uoM                           String          @map("unit_of_measurement")
  quantity                      Decimal         @db.Decimal(15, 2)
  totalValues                   Decimal         @map("total_values") @db.Decimal(15, 2)
  valueSalesExcludingST         Decimal         @map("value_sales_excluding_st") @db.Decimal(15, 2)
  fixedNotifiedValueOrRetailPrice Decimal       @map("fixed_notified_value_or_retail_price") @db.Decimal(15, 2)
  salesTaxApplicable            Decimal         @map("sales_tax_applicable") @db.Decimal(15, 2)
  salesTaxWithheldAtSource      Decimal         @map("sales_tax_withheld_at_source") @db.Decimal(15, 2)
  extraTax                      String?         @map("extra_tax")
  furtherTax                    Decimal         @map("further_tax") @db.Decimal(15, 2)
  sroScheduleNo                 String?         @map("sro_schedule_no")
  fedPayable                    Decimal         @map("fed_payable") @db.Decimal(15, 2)
  discount                      Decimal         @db.Decimal(15, 2)
  saleType                      String?         @map("sale_type")
  sroItemSerialNo               String?         @map("sro_item_serial_no")
  createdAt                     DateTime        @default(now()) @map("created_at")
  updatedAt                     DateTime        @updatedAt @map("updated_at")
  
  // Relations
  invoice                       Invoice         @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  hsCode                        HsCode          @relation(fields: [hsCodeId], references: [id], onDelete: Restrict)
  customFieldValues             InvoiceItemCustomFieldValue[]

  @@map("invoice_items")
}

model CustomField {
  id                      String                     @id @default(uuid())
  userId                  String                     @map("user_id")
  fieldName               String                     @map("field_name")
  fieldType               String                     @map("field_type") // 'text', 'number', 'date', etc.
  isActive                Boolean                    @default(true) @map("is_active")
  createdAt               DateTime                   @default(now()) @map("created_at")
  updatedAt               DateTime                   @updatedAt @map("updated_at")
  
  // Relations
  user                    User                       @relation(fields: [userId], references: [id], onDelete: Cascade)
  invoiceItemCustomFieldValues InvoiceItemCustomFieldValue[]

  @@unique([userId, fieldName])
  @@map("custom_fields")
}

model InvoiceItemCustomFieldValue {
  id                      String       @id @default(uuid())
  invoiceItemId           String       @map("invoice_item_id")
  customFieldId           String       @map("custom_field_id")
  value                   String       // Store all values as string, convert based on fieldType
  createdAt               DateTime     @default(now()) @map("created_at")
  updatedAt               DateTime     @updatedAt @map("updated_at")
  
  // Relations
  invoiceItem             InvoiceItem  @relation(fields: [invoiceItemId], references: [id], onDelete: Cascade)
  customField             CustomField  @relation(fields: [customFieldId], references: [id], onDelete: Cascade)

  @@unique([invoiceItemId, customFieldId])
  @@map("invoice_item_custom_field_values")
}

model InvoicePrintSettings {
  id                      String       @id @default(uuid())
  userId                  String       @unique @map("user_id")
  
  // Field visibility settings (JSON array - includes both regular fields AND custom field IDs with customField_ prefix)
  visibleFields           Json         @map("visible_fields")
  
  // Column width settings (JSON object - includes widths for both regular and custom fields)
  columnWidths            Json         @map("column_widths")
  
  // General settings
  fontSize                String       @default("small") @map("font_size") // "small", "medium", "large"
  tableBorders            Boolean      @default(true) @map("table_borders")
  showItemNumbers         Boolean      @default(true) @map("show_item_numbers")
  
  createdAt               DateTime     @default(now()) @map("created_at")
  updatedAt               DateTime     @updatedAt @map("updated_at")
  
  // Relations
  user                    User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("invoice_print_settings")
}

enum Role {
  ADMIN
  USER
}
